name: Repository Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (owner/repo)'
        required: true
        default: ''
      source_branch:
        description: 'Source branch to sync from'
        required: true
        default: 'main'
      target_branch:
        description: 'Target branch to sync to'
        required: true
        default: 'master'
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    # Note: Configure source repository in the workflow to enable scheduled syncing
    - cron: '0 0 * * 0'

env:
  NODE_VERSION: '20'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_PAT }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Validate sync parameters
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual sync triggered"
            echo "Source: ${{ github.event.inputs.source_repo }}"
            echo "Source branch: ${{ github.event.inputs.source_branch }}"
            echo "Target branch: ${{ github.event.inputs.target_branch }}"
            
            if [ -z "${{ github.event.inputs.source_repo }}" ]; then
              echo "❌ Error: Source repository is required"
              exit 1
            fi
          else
            echo "Scheduled sync - configure source repository in workflow"
          fi

      - name: Add upstream remote
        if: github.event_name == 'workflow_dispatch'
        run: |
          git remote add upstream https://${{ secrets.GITHUB_PAT }}@github.com/${{ github.event.inputs.source_repo }}.git
          git fetch upstream ${{ github.event.inputs.source_branch }}

      - name: Sync changes
        if: github.event_name == 'workflow_dispatch'
        run: |
          SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
          TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
          
          echo "Syncing upstream/${SOURCE_BRANCH} to origin/${TARGET_BRANCH}"
          
          # Create a new branch for sync
          SYNC_BRANCH="sync/${SOURCE_BRANCH}-$(date +%Y%m%d-%H%M%S)"
          git checkout -b ${SYNC_BRANCH}
          
          # Attempt to merge upstream changes
          if git merge upstream/${SOURCE_BRANCH} --no-edit; then
            echo "✅ Merge successful"
            git push origin ${SYNC_BRANCH}
            
            echo "SYNC_BRANCH=${SYNC_BRANCH}" >> $GITHUB_ENV
            echo "SYNC_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "❌ Merge conflicts detected"
            git merge --abort
            echo "SYNC_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        if: env.SYNC_SUCCESS == 'true' && github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_PAT }}
          script: |
            const syncBranch = process.env.SYNC_BRANCH;
            const targetBranch = '${{ github.event.inputs.target_branch }}';
            const sourceRepo = '${{ github.event.inputs.source_repo }}';
            const sourceBranch = '${{ github.event.inputs.source_branch }}';
            
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `chore: sync from ${sourceRepo}/${sourceBranch}`,
              head: syncBranch,
              base: targetBranch,
              body: `## Repository Sync
              
              This PR syncs changes from the upstream repository.
              
              **Source**: \`${sourceRepo}\` (branch: \`${sourceBranch}\`)
              **Target**: \`${targetBranch}\`
              **Sync Date**: ${new Date().toISOString()}
              
              ### Changes
              
              Please review the changes carefully before merging.
              
              ### Checklist
              
              - [ ] Review all changes
              - [ ] Verify no conflicts
              - [ ] Test locally if needed
              - [ ] Approve and merge
              
              ---
              *Automated sync by GitHub Actions*`
            });

      - name: Notify on conflict
        if: env.SYNC_SUCCESS == 'false' && github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sourceRepo = '${{ github.event.inputs.source_repo }}';
            const sourceBranch = '${{ github.event.inputs.source_branch }}';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Repo sync conflict: ${sourceRepo}/${sourceBranch}`,
              body: `## ⚠️ Repository Sync Conflict
              
              Automatic sync from \`${sourceRepo}\` (branch: \`${sourceBranch}\`) failed due to merge conflicts.
              
              **Action Required**: Manual resolution needed
              
              ### Steps to Resolve
              
              1. Clone the repository locally
              2. Add upstream remote: \`git remote add upstream https://github.com/${sourceRepo}.git\`
              3. Fetch upstream: \`git fetch upstream ${sourceBranch}\`
              4. Create a new branch: \`git checkout -b sync-fix\`
              5. Merge and resolve conflicts: \`git merge upstream/${sourceBranch}\`
              6. Resolve conflicts manually
              7. Commit and push: \`git push origin sync-fix\`
              8. Create a PR for review
              
              ---
              *Automated notification by GitHub Actions*`,
              labels: ['sync', 'needs-attention']
            });

      - name: Summary
        if: always()
        run: |
          echo "### Repository Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.SYNC_SUCCESS }}" = "true" ]; then
            echo "✅ Sync completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "- Pull request created for review" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ env.SYNC_SUCCESS }}" = "false" ]; then
            echo "❌ Sync failed due to conflicts" >> $GITHUB_STEP_SUMMARY
            echo "- Issue created for manual resolution" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ Scheduled sync - configure source repository" >> $GITHUB_STEP_SUMMARY
          fi
